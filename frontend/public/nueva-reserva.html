<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nueva Reserva – Transporte2Work</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="css/estilos.css" />
  <style>
    .form-container { max-width: 600px; margin: 2rem auto; }
    .form-group { margin-bottom: 1.2rem; }
    .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; }
    .form-group select, .form-group input { width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 6px; }
    .btn { background: var(--secondary); color: white; padding: 0.75rem 2rem; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; }
    .btn:hover { background: #ea580c; }
  </style>
</head>
<body>

  <header class="header">
    <nav class="navbar">
      <div class="logo">T2W</div>
      <ul class="nav-menu">
        <li><a href="index.html"><i class="bi bi-house-door"></i> Inicio</a></li>
        <li><a href="servicios.html"><i class="bi bi-gear"></i> Servicios</a></li>
        <li><a href="mis-reservas.html"><i class="bi bi-ticket"></i> Mis reservas</a></li>
        <li><a href="contacto.html"><i class="bi bi-envelope"></i> Contáctenos</a></li>
      </ul>
      <div class="hamburger">
        <span></span><span></span><span></span>
      </div>
    </nav>
  </header>

  <section class="hero hero-simple">
    <div class="hero-overlay">
      <h1>Nueva Reserva</h1>
      <p>Selecciona un autobús y las fechas de tu pase mensual</p>
    </div>
  </section>

  <main class="section">
    <div class="container form-container">
      <form id="reservaForm">
        <div class="form-group">
          <label for="bus">Selecciona un autobús</label>
          <select id="bus" required>
            <option value="">-- Elige un autobús --</option>
            <!-- Se llenará con AJAX -->
          </select>
        </div>
        <div class="form-group">
          <label for="fecha_inicio">Fecha de inicio</label>
          <input type="date" id="fecha_inicio" required>
        </div>
        <div class="form-group">
          <label for="fecha_fin">Fecha de fin</label>
          <input type="date" id="fecha_fin" required>
        </div>
        <button type="submit" class="btn">Crear reserva</button>
        <a href="mis-reservas.html" style="display: block; margin-top: 1rem; color: var(--primary);">← Volver a mis reservas</a>
      </form>
      <p id="mensaje" style="margin-top: 1rem; color: green; font-weight: bold;"></p>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>© 2025 Transporte2Work. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script src="js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const usuario = JSON.parse(localStorage.getItem('usuario'));
      if (!usuario || !usuario.identificacion) {
        alert('Debes iniciar sesión para crear una reserva.');
        window.location.href = 'login.html';
        return;
      }

      // Cargar lista de buses
      try {
        const res = await fetch('/admin/buses');
        const buses = await res.json();
        const select = document.getElementById('bus');
        buses.forEach(bus => {
          const opt = document.createElement('option');
          opt.value = bus.id;
          opt.textContent = `${bus.modelo} (${bus.placa}) - Capacidad: ${bus.capacidad}`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        document.getElementById('bus').innerHTML += '<option value="">Error al cargar buses</option>';
      }

      // Enviar formulario
      document.getElementById('reservaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          identificacion: usuario.identificacion,
          bus_id: document.getElementById('bus').value,
          fecha_inicio: document.getElementById('fecha_inicio').value,
          fecha_fin: document.getElementById('fecha_fin').value
        };

        try {
          const res = await fetch('/api/reservas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            document.getElementById('mensaje').textContent = '¡Reserva creada con éxito!';
            document.getElementById('reservaForm').reset();
            setTimeout(() => window.location.href = 'mis-reservas.html', 1500);
          } else {
            const err = await res.json();
            alert('Error: ' + (err.error || 'No se pudo crear la reserva'));
          }
        } catch (err) {
          alert('Error de conexión al crear la reserva.');
        }
      });
    });
  </script>
</body>
</html>