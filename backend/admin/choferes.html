<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Choferes - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h1>Choferes</h1>

    <button id="btnNuevo" class="btn btn-success mb-3">Nuevo Chofer</button>

    <table class="table table-striped" id="tablaChoferes">
      <thead>
        <tr>
          <th>ID</th><th>Nombre</th><th>Teléfono</th><th>Cédula</th><th>Licencia</th><th>Fecha Contratación</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalChofer" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formChofer">
          <div class="modal-header">
            <h5 class="modal-title">Chofer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="choferId">

            <div class="mb-3">
              <label>Nombre</label>
              <input id="nombre" class="form-control" required>
            </div>

            <div class="mb-3">
              <label>Teléfono</label>
              <input id="telefono" class="form-control" required>
            </div>

            <div class="mb-3">
              <label>Cédula</label>
              <input id="cedula" class="form-control" required>
            </div>

            <div class="mb-3">
              <label>Tipo Licencia</label>
              <input id="licencia" class="form-control" required>
            </div>

            <div class="mb-3">
              <label>Fecha Contratación</label>
              <input id="fecha" type="date" class="form-control" required>
            </div>

          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiBase = "/admin";
const modal = new bootstrap.Modal(document.getElementById("modalChofer"));

async function cargarChoferes() {
  const res = await fetch(apiBase + "/choferes");
  const datos = await res.json();
  const tbody = document.querySelector("#tablaChoferes tbody");
  tbody.innerHTML = "";

  datos.forEach(ch => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ch.id}</td>
      <td>${ch.nombre}</td>
      <td>${ch.telefono}</td>
      <td>${ch.cedula}</td>
      <td>${ch.licencia_tipo}</td>
      <td>${ch.fecha_contratacion}</td>
      <td>
        <button class="btn btn-sm btn-primary btn-edit" data-id="${ch.id}">Editar</button>
        <button class="btn btn-sm btn-danger btn-del" data-id="${ch.id}">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".btn-edit").forEach(b => b.onclick = editarChofer);
  document.querySelectorAll(".btn-del").forEach(b => b.onclick = eliminarChofer);
}

document.getElementById("btnNuevo").onclick = () => {
  document.getElementById("formChofer").reset();
  document.getElementById("choferId").value = "";
  modal.show();
};

document.getElementById("formChofer").onsubmit = async (e) => {
  e.preventDefault();

  const id = document.getElementById("choferId").value;

  const payload = {
    nombre: document.getElementById("nombre").value,
    telefono: document.getElementById("telefono").value,
    cedula: document.getElementById("cedula").value,
    licencia_tipo: document.getElementById("licencia").value,
    fecha_contratacion: document.getElementById("fecha").value
  };

  if (id) {
    await fetch(`${apiBase}/choferes/${id}`, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
  } else {
    await fetch(`${apiBase}/choferes`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
  }

  modal.hide();
  cargarChoferes();
};

async function editarChofer(ev) {
  const id = ev.currentTarget.dataset.id;
  const res = await fetch(apiBase + "/choferes");
  const lista = await res.json();
  const ch = lista.find(x => x.id == id);

  document.getElementById("choferId").value = ch.id;
  document.getElementById("nombre").value = ch.nombre;
  document.getElementById("telefono").value = ch.telefono;
  document.getElementById("cedula").value = ch.cedula;
  document.getElementById("licencia").value = ch.licencia_tipo;
  document.getElementById("fecha").value = ch.fecha_contratacion;

  modal.show();
}

async function eliminarChofer(ev) {
  if (!confirm("¿Eliminar chofer?")) return;
  const id = ev.currentTarget.dataset.id;
  await fetch(`${apiBase}/choferes/${id}`, {method: "DELETE"});
  cargarChoferes();
}

cargarChoferes();
</script>
</body>
</html>
