<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Usuarios - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

  <header id="navbar-container"></header>

  <div id="sidebar-container"></div>
  <main class="content-offset">
      <div class="container">
    <div class="page-header">
      <h1 class="page-title">Usuarios</h1>
      <button id="btnNuevo" class="btn btn-action">
        <i class="bi bi-plus-circle me-1"></i> Nuevo Usuario
      </button>
    </div>

    <div class="table-container">
      <table class="table" id="tablaUsuarios">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Rol</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
<div class="modal fade" id="modalUser" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gestionar Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="guardarUsuario">Guardar cambios</button>
      </div>
    </div>
  </div>
</div>
  </main>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/scripts.js"></script>
  <script src="js/active-link.js"></script>
<script>
  const modalEl = new bootstrap.Modal(document.getElementById('modalUser'));
  const apiBase = '/admin';
  let editingId = null;

  function renderRol(rol) {
    return rol === 'admin'
      ? '<span class="badge bg-danger">Administrador</span>'
      : '<span class="badge bg-secondary">Usuario</span>';
  }

  async function fetchUsuarios() {
    try {
      const res = await fetch(apiBase + '/usuarios');
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Error al cargar usuarios');
      }
      const data = await res.json();
      const tbody = document.querySelector('#tablaUsuarios tbody');
      tbody.innerHTML = '';
      data.forEach(u => {
        const fullName = `${u.nombre} ${u.primer_apellido} ${u.segundo_apellido || ''}`.trim();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${fullName}</td>
          <td>${u.correo}</td>
          <td>${renderRol(u.rol)}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary me-1 btn-edit" data-id="${u.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger btn-del" data-id="${u.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      // Enlazar eventos
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => editarUsuario(btn.dataset.id));
      });
      document.querySelectorAll('.btn-del').forEach(btn => {
        btn.addEventListener('click', () => eliminarUsuario(btn.dataset.id));
      });
    } catch (err) {
      console.error('Error:', err);
      alert('Error al cargar usuarios: ' + err.message);
    }
  }

  // ABRIR MODAL PARA NUEVO USUARIO
  document.getElementById('btnNuevo').addEventListener('click', () => {
    editingId = null;
    actualizarModal(null);
    modalEl.show();
  });

  // BOTÓN GUARDAR DEL MODAL
  document.getElementById('guardarUsuario').addEventListener('click', async () => {
    const payload = {
      identificacion: document.getElementById('identificacion').value,
      nombre: document.getElementById('nombre').value,
      primer_apellido: document.getElementById('primer_apellido').value,
      segundo_apellido: document.getElementById('segundo_apellido').value || '',
      correo: document.getElementById('correo').value,
      telefono: document.getElementById('telefono').value,
      contrasena: document.getElementById('contrasena').value,
      rol: document.getElementById('rol').value
    };

    // Validación
    if (!payload.identificacion || !payload.nombre || !payload.primer_apellido || 
        !payload.correo || !payload.telefono || !payload.contrasena) {
      alert('Todos los campos con * son obligatorios.');
      return;
    }

    try {
      const url = editingId ? `${apiBase}/usuarios/${editingId}` : `${apiBase}/usuarios`;
      const method = editingId ? 'PUT' : 'POST';
      
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Error al guardar');
      }

      modalEl.hide();
      fetchUsuarios();
    } catch (err) {
      console.error('Error:', err);
      alert('Error: ' + err.message);
    }
  });

  // EDITAR USUARIO
  async function editarUsuario(id) {
    try {
      const res = await fetch(`${apiBase}/usuarios/${id}`);
      if (!res.ok) throw new Error('Usuario no encontrado');
      const user = await res.json();
      editingId = user.id;
      actualizarModal(user);
      modalEl.show();
    } catch (err) {
      alert('Error al cargar usuario: ' + err.message);
    }
  }

  // ELIMINAR USUARIO
  async function eliminarUsuario(id) {
    if (!confirm('¿Eliminar usuario? Esta acción es irreversible.')) return;
    try {
      const res = await fetch(`${apiBase}/usuarios/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Error al eliminar');
      fetchUsuarios();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  }

  // ACTUALIZAR EL MODAL CON DATOS
  function actualizarModal(user) {
    const modalBody = document.querySelector('#modalUser .modal-body');
    const campos = `
      <div class="mb-3">
        <label class="form-label">Identificación *</label>
        <input id="identificacion" class="form-control" required placeholder="Ej: 1-1234-5678" ${user ? 'disabled' : ''}>
      </div>
      <div class="mb-3">
        <label class="form-label">Nombre(s) *</label>
        <input id="nombre" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Primer apellido *</label>
        <input id="primer_apellido" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Segundo apellido</label>
        <input id="segundo_apellido" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Correo electrónico *</label>
        <input id="correo" type="email" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Teléfono *</label>
        <input id="telefono" class="form-control" required placeholder="Ej: 8888-8888">
      </div>
      <div class="mb-3">
        <label class="form-label">Rol</label>
        <select id="rol" class="form-select">
          <option value="usuario">Usuario</option>
          <option value="admin">Administrador</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Contraseña *</label>
        <input id="contrasena" class="form-control" placeholder="••••••••" required>
      </div>
    `;
    modalBody.innerHTML = campos;

    // Rellenar si es edición
    if (user) {
      document.getElementById('identificacion').value = user.identificacion;
      document.getElementById('nombre').value = user.nombre;
      document.getElementById('primer_apellido').value = user.primer_apellido;
      document.getElementById('segundo_apellido').value = user.segundo_apellido || '';
      document.getElementById('correo').value = user.correo;
      document.getElementById('telefono').value = user.telefono;
      document.getElementById('rol').value = user.rol;
      document.getElementById('contrasena').value = ''; // por seguridad
    }
  }

  // INICIAR
  fetchUsuarios();
</script>
</body>
</html>
