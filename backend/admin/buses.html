<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Buses - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h1>Buses</h1>
    <button id="btnNuevo" class="btn btn-success mb-3">Nuevo Bus</button>
    <table class="table table-striped" id="tablaBuses">
      <thead><tr><th>ID</th><th>Placa</th><th>Modelo</th><th>Capacidad</th><th>Costo/km</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalBus" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formBus">
          <div class="modal-header"><h5 class="modal-title">Bus</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" id="busId">
            <div class="mb-3"><label>Placa</label><input id="placa" class="form-control" required></div>
            <div class="mb-3"><label>Modelo</label><input id="modelo" class="form-control" required></div>
            <div class="mb-3"><label>Capacidad</label><input id="capacidad" type="number" class="form-control" required></div>
            <div class="mb-3"><label>Costo por km</label><input id="costo_km" type="number" step="0.01" class="form-control"></div>
            <div class="mb-3"><label>Chofer asignado</label><select id="chofer_id" class="form-control" required></select></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {

const modalBus = new bootstrap.Modal(document.getElementById('modalBus'));
const apiBase = '/admin';

/* ================================
   CARGAR LISTA DE CHOFERES
================================ */
async function cargarChoferes() {
  const res = await fetch(apiBase + '/choferes');
  const data = await res.json();

  const select = document.getElementById('chofer_id');
  select.innerHTML = '<option value="">Seleccione un chofer</option>';

  data.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.nombre;
    select.appendChild(opt);
  });
}

/* ================================
   LISTAR BUSES EN TABLA
================================ */
async function fetchBuses(){
  const res = await fetch(apiBase + '/buses');
  const data = await res.json();
  const tbody = document.querySelector('#tablaBuses tbody');
  tbody.innerHTML = '';

  data.forEach(b => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${b.id}</td>
      <td>${b.placa}</td>
      <td>${b.modelo}</td>
      <td>${b.capacidad}</td>
      <td>${b.costo_km ?? ''}</td>
      <td>
          <button class="btn btn-sm btn-primary btn-edit" data-id="${b.id}">Editar</button>
          <button class="btn btn-sm btn-danger btn-del" data-id="${b.id}">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.btn-edit').forEach(b => b.onclick = editarBus);
  document.querySelectorAll('.btn-del').forEach(b => b.onclick = eliminarBus);
}

/* ================================
   NUEVO BUS
================================ */
document.getElementById('btnNuevo').onclick = async () => {
  await cargarChoferes();
  document.getElementById('formBus').reset();
  document.getElementById('busId').value='';
  modalBus.show();
};

/* ================================
   GUARDAR BUS
================================ */
document.getElementById('formBus').onsubmit = async (e) => {
  e.preventDefault();

  const id = document.getElementById('busId').value;

  const payload = {
    placa: document.getElementById('placa').value,
    modelo: document.getElementById('modelo').value,
    capacidad: parseInt(document.getElementById('capacidad').value),
    costo_km: parseFloat(document.getElementById('costo_km').value) || 0,
    chofer_id: parseInt(document.getElementById('chofer_id').value)
  };

  if(id){
    await fetch(`${apiBase}/buses/${id}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
  } else {
    await fetch(`${apiBase}/buses`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
  }

  modalBus.hide();
  fetchBuses();
};

/* ================================
   EDITAR BUS
================================ */
async function editarBus(ev){
  const id = ev.currentTarget.dataset.id;

  const res = await fetch(apiBase + '/buses');
  const buses = await res.json();
  const b = buses.find(x => x.id == id);

  await cargarChoferes();

  document.getElementById('busId').value = b.id;
  document.getElementById('placa').value = b.placa;
  document.getElementById('modelo').value = b.modelo;
  document.getElementById('capacidad').value = b.capacidad;
  document.getElementById('costo_km').value = b.costo_km ?? "";
  document.getElementById('chofer_id').value = b.chofer_id ?? "";

  modalBus.show();
}

/* ================================
   ELIMINAR BUS
================================ */
async function eliminarBus(ev){
  if(!confirm('Â¿Eliminar bus?')) return;
  const id = ev.currentTarget.dataset.id;
  await fetch(`${apiBase}/buses/${id}`, {method:'DELETE'});
  fetchBuses();
}

/* ================================
   CARGA INICIAL
================================ */
fetchBuses();

});
</script>
</body>
</html>

